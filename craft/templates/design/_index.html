{#
# Design Index template
# _________________________
#
# This template gets loaded whenever the Design index is requested, because
# the Design Index single_entry section's Template setting is set to
# "design/_index".
#
# An `entry` variable will be automatically passed to this template, which will
# be set to the Design Index entry.
_#}

{% extends "_layouts/site" %}
{% set bodyClass = "design" %}

{# Setting up the tag filter stuff #}
{% set disciplineQuery = craft.request.getParam('discipline') %}

{# Then find categories that match the slugs in your query string. #}
{% set disciplineTags = craft.entries.slug(disciplineQuery)|merge([craft.tags.group('disciplines').slug(disciplineQuery)]) %}

{% set years = [2016, 2015, 2014, 2013, 2012] %}
{% set entryYears = [] %}

{# =========================== Filter Form =========================== #}

{% block main %}
<div id="d_filter">
	<form action="http://dev.sfuitaliadesign.com/design">
		<input id="search" type="search" name="discipline" placeholder="type to search" onchange='this.form.submit()'>
		{# <select name="discipline" onchange='this.form.submit()'>
		<option value=""></option>
		{% for tag in craft.tags.group('disciplines') %}
		<option value="{{tag.slug}}" {{ tag.slug in disciplineQuery ? 'selected'}}>{{tag.title}}</option>
		{% endfor %}
		</select> #}
	</form>
	<span class="oHidden">x</span>
</div>

{# =========================== Find Entries Logic =========================== #}

	{# One year at a time #}
	{% for year in years %}
		{# setup your search parameters #}
		{% set designerParams = {
			relatedTo:  disciplineTags,
			section: 'design',
			type: 'designer',
			videoYear: year
		} %}
		{% set filmParams = {
			relatedTo:  disciplineTags,
			section: 'design',
			type: 'shortFilm',
			videoYear: year
		} %}

		{# Find your entries #}
		{% set designerEntries = craft.entries(designerParams).order('postDate desc') %}
		{% set filmEntries = craft.entries(filmParams).order('postDate desc') %}
		{% set filmOffset = designerEntries|length // filmEntries|length %}
		{% set entries = [] %}

		{# Rearrange entries #}
		{% if filmEntries|length and designerEntries|length %}
			{% for i in 0..(filmEntries|length-1) %}
				{# Film Entry #}
				{% set entries = entries|merge([filmEntries.nth(i)]) %}
				{# Designer Entries #}
				{% set entries = entries|merge(
					designerEntries|slice(
						(i*filmOffset),
						((i*filmOffset)+(filmOffset - 1))
					)
				) %}
			{% endfor %}
			{% set entries = entries|merge(
				designerEntries|slice(
					(filmOffset*filmEntries - 1),
					(designerEntries|length)
				)
			) %}
		{% elseif designerEntries|length %}
			{# No short films in this year #}
			{% set entries = designerEntries %}
		{% endif %}

{# =========================== Display Entries =========================== #}

		{% if entries | length %}
			{% set entryYears = entryYears|merge([year]) %}
			<h1 id="year_title_{{year}}">{{year}}</h1>
			<section id="flex_grid_{{year}}" class="flexbox_grid clearfix">
				{% for entry in entries %}
					<article class="{{entry.type == 'shortFilm' ? 'film_entry' : 'design_entry'}} item">
						{% if entry.type == "interviewVideo" %}
							{% set image = entry.parent.intPortrait.first %}
						{% else %}
							{% set image = entry.intPortrait.first %}
						{% endif %}
						<a href="{{ entry.url }}">
							{% if image %}
								<div class="entry_thumb_cont">
									<img src="{{ image.url }}" alt="{{ image.title }}">
								</div>
							{% else %}
								<div class="entry_thumb_cont">
									<img src="http://dev.sfuitaliadesign.com/assets/images/portraits/placeholder-image.jpg" alt="Placeholder image">
								</div>
							{% endif %}
							<div class="entry_title">
								<h3>{{ entry }}</h3>
								<span>{{entry.type != 'shortFilm'?entry.companyField}}</span>
							</div>
						</a>
					</article>
				{% endfor %}
			</section>
		{% else %}
		{# <p>That's strange, we couldn't find anything, our bad. Maybe try looking for something else? We'll fix this ASAP!</p> #}
		{% endif %}
	{% endfor %}
	<div id="year_links">
		<ul>
			{% for year in entryYears %}
				<li>
					<a href="#year_title_{{year}}">
						{{year}}
					</a>
				</li>
			{% endfor %}
		</ul>
	</div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
	<script src="/js/designIndex.js"></script>
{% endblock %}
